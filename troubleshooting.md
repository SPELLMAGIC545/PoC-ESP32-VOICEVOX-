# ESP32-AI音声対話システム 問題切り分けガイド

ご提示いただいたシステムが正常に動作しないとのこと、承知いたしました。このような複数の要素が連携するシステムでは、一つ一つの部品が正しく動くかを確認していく「**問題の切り分け**」が非常に重要です。

以下に、問題を特定するための検証手順を機能ごとに4つのステップで提案します。簡単なものから順に試してみてください。

## ステップ1：【最重要】ネットワーク接続の検証 🌐

まず、すべての機器が同じネットワーク上で正しく通信できるかを確認します。ここが全ての土台となります。

  * **目的**:
    ESP32が立てたアクセスポイント(AP)に、サーバーPCとユーザー端末が正しく接続できているかを確認する。

  * **検証手順**:

    1.  `esp32_main.py` を書き込んだESP32を起動します。
    2.  **サーバーPC**のWi-Fi設定を開き、SSID「`omocha`」に接続します。
    3.  サーバーPCでターミナル（コマンドプロンプトやPowerShell）を開き、`ipconfig`（Mac/Linuxなら `ip a`）を実行します。
    4.  表示されたIPアドレスが `192.168.4.x`（例: `192.168.4.2`）のようになっていることを確認します。
    5.  次に、ESP32（`192.168.4.1`）と通信できるかを確認するために、`ping` コマンドを実行します。
        ```bash
        ping 192.168.4.1
        ```
    6.  ユーザー端末（スマートフォンなど）も同様に「`omocha`」に接続し、`192.168.4.x` のIPアドレスが割り当てられていることを確認します。

  * **期待する結果**:

      * サーバーPCとユーザー端末に `192.168.4.x` 形式のIPアドレスが割り当てられている。
      * `ping` コマンドに対して「応答」が返ってくる。

  * **もし動かなかったら**:

      * **`192.168.4.x` のIPが取得できない**: ESP32のAP機能が正常に動いていない可能性があります。`esp32_main.py`の `AP_SSID` や `AP_PASSWORD` の設定を見直してください。
      * **pingが通らない**: 物理的な距離が遠いか、サーバーPCのファイアウォールが通信をブロックしている可能性があります。一時的にファイアウォールを無効にして試してみてください。

-----

## ステップ2：サーバーPC上のサービスの単体動作確認 🖥️

次に、サーバーPC上で動作するOllamaとVOICEVOXが、それぞれ単体で正常にリクエストを処理できるかを確認します。

  * **目的**:
    AIモデルと音声合成エンジンが正しく起動し、APIリクエストに応答するかを確認する。

  * **検証手順**:

    1.  **Ollamaの確認**: サーバーPCのターミナルで以下の`curl`コマンドを実行します。これは、`voice_chat_server.py` が内部で行う処理を擬似的に実行するものです。
        ```bash
        curl http://localhost:11434/api/chat -d '{"model": "sarashina2.2-0.5b:latest", "messages": [{"role": "user", "content": "こんにちは"}], "stream": false}'
        ```
    2.  **VOICEVOXの確認**: Webブラウザで `http://localhost:50021/docs` を開きます。

  * **期待する結果**:

      * Ollamaのコマンドに対して、AIからの応答メッセージを含むJSONデータが返ってくる。
      * VOICEVOXのURLにアクセスすると、APIのドキュメントページ（Swagger UI）が表示される。

  * **もし動かなかったら**:

      * **Ollamaでエラー**: Ollamaが起動していない、または指定したモデル（`sarashina2.2-0.5b:latest`）がインストールされていない可能性があります。`ollama list` コマンドでモデル一覧を確認してください。
      * **VOICEVOXでエラー**: VOICEVOX Engineが起動していない可能性があります。起動し直してください。

-----

## ステップ3：中間サーバー (`voice_chat_server.py`) の動作確認 📞

次に、ESP32からのリクエストを受け取る中間サーバーが、OllamaやVOICEVOXと正しく連携できるかを確認します。

  * **目的**:
    `voice_chat_server.py` が擬似的なリクエストを受け取り、AI応答生成と音声ファイル作成を実行できるかを確認する。

  * **検証手順**:

    1.  `voice_chat_server.py` を実行します。コンソールに「`サーバーを開始しました`」と表示されることを確認します。
    2.  **ESP32の代わりに**、サーバーPCの別のターミナルから以下の`curl`コマンドを実行して、自分自身にリクエストを送ります。
        ```bash
        curl -X POST -H "Content-Type: application/json" -d "{\"messages\": [{\"role\": \"system\", \"content\": \"あなたは親切なアシスタントです。\"},{\"role\": \"user\", \"content\": \"これはサーバーの単体テストです\"}]}" http://localhost:8001/chat
        ```

  * **期待する結果**:

      * `voice_chat_server.py` を実行しているコンソールに、「リクエスト受信」「Ollamaに問い合わせ中」「VOICEVOXで音声を生成中」などのログが表示される。
      * スクリプトと同じディレクトリに `output_(日時).wav` という名前の音声ファイルが作成される。
      * `curl` を実行したターミナルに、AIからの応答メッセージ（JSON形式）が返ってくる。

  * **もし動かなかったら**:

      * **サーバーが起動しない**: ポート`8001`が他のアプリケーションで使用されている可能性があります。
      * **ログにOllamaやVOICEVOXへの接続エラーが出る**: スクリプト内の `OLLAMA_API_URL` や `VOICEVOX_API_URL` の設定が間違っている可能性があります。
      * **ファイルが生成されない**: スクリプトを実行しているディレクトリに書き込み権限がない可能性があります。

-----

## ステップ4：ESP32とサーバーPCの連携確認 🔗

最後に、全てのコンポーネントを繋ぎ、実際の流れに沿って動作を確認します。

  * **目的**:
    ユーザー端末からの入力が、ESP32を経由してサーバーPCに正しく届き、応答が返ってくるかを確認する。

  * **検証手順**:

    1.  **【最重要チェック項目】**: `esp32_main.py` を開きます。`SERVER_PC_URL` に設定されているIPアドレスが、**ステップ1で確認したサーバーPCの実際のIPアドレス**（例: `192.168.4.2`）と一致しているか、**必ず確認・修正**してください。
        ```python
        # esp32_main.py のこの部分
        # 例: サーバーPCのIPが 192.168.4.2 の場合
        SERVER_PC_URL = "http://192.168.4.2:8001/chat" 
        ```
    2.  PCで`voice_chat_server.py`を起動します。
    3.  ESP32を起動し、PCのシリアルモニターを接続してログを監視できるようにしておきます。
    4.  ユーザー端末（スマホ等）をWi-Fi「`omocha`」に接続し、ブラウザで `http://192.168.4.1` を開きます。
    5.  チャット画面からメッセージを送信します。

  * **デバッグのポイント**:

      * **ESP32のシリアルモニター** と **サーバーPCのコンソール** の両方を同時に見てください。
      * メッセージ送信後、ESP32のモニターに「`サーバーPC (...) に問い合わせ中...`」と表示されるか？
      * その直後、サーバーPCのコンソールに「`--- ESP32からリクエスト受信 ---`」と表示されるか？

  * **考えられる主な原因**:

      * **最も多い原因**: `esp32_main.py`の`SERVER_PC_URL`のIPアドレス設定ミス。
      * **次に多い原因**: サーバーPCの**ファイアウォール**がポート `8001` への外部からのアクセスをブロックしている。一時的に無効にして試すか、受信規則を追加してください。
      * ESP32とサーバーPC間のWi-Fi接続が不安定。

これらのステップを順に試すことで、問題がネットワーク層にあるのか、個別のアプリケーションにあるのか、あるいはそれらの連携部分にあるのかを効率的に特定できるはずです。頑張ってください！