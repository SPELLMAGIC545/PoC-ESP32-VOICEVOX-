
# ESP32-AI音声対話システム

## 1\. 概要

本システムは、**ESP32**をWebサーバー兼アクセスポイントとして利用し、ユーザーがブラウザ経由でAIとチャットできる対話システムです。ユーザーからの入力は、ローカルネットワーク内の**サーバーPC**に転送されます。サーバーPCはAIモデル**Ollama**で応答テキストを生成し、そのテキストを音声合成エンジン**VOICEVOX**で音声ファイルとして保存します。生成されたテキストはESP32経由でユーザーのブラウザに返却されます。

## 2\. システム構成

本システムは「ESP32」「サーバーPC」「ユーザー端末」の3つのコンポーネントで構成されます。各コンポーネントは、ESP32が構築するWi-Fiネットワーク内で連携して動作します。

| コンポーネント | 役割 | 使用ソフトウェア |
| :--- | :--- | :--- |
| **ESP32** | Wi-Fiアクセスポイント、Webサーバー、会話履歴の管理 | `esp32_main.py` (MicroPython) |
| **サーバーPC** | AI応答生成、音声合成、中間サーバー機能 | `voice_chat_server.py`, Ollama, VOICEVOX Engine |
| **ユーザー端末** | チャットUIの表示、ユーザー入力 | Webブラウザ (スマートフォン、PCなど) |

-----

## 3\. 処理フロー

ユーザーがメッセージを送信してから応答が表示されるまでの処理の流れは以下の通りです。

1.  **ユーザー**は、ESP32のWi-Fiに接続し、ブラウザでチャット画面 (`http://192.168.4.1`) を開きます。
2.  ユーザーがメッセージを送信すると、リクエストは**ESP32**に送信されます。
3.  **ESP32**は、保持している過去の会話履歴と新しいメッセージをまとめて、**サーバーPC**の`voice_chat_server.py`に転送します。
4.  **サーバーPC**は、ESP32から受信した会話データを**Ollama**に渡し、AIによる応答テキストを生成させます。
5.  **サーバーPC**は、生成されたテキストを**VOICEVOX Engine**に渡し、音声ファイル(`.wav`)をPC上に保存します。
6.  **サーバーPC**は、生成された応答テキストを**ESP32**に返します。
7.  **ESP32**は、受信したテキストをWebサーバー経由で**ユーザー**のブラウザに返し、画面に応答が表示されます。

-----

## 4\. ネットワーク要件

本システムの最も重要な要件は、**サーバーPCがESP32のWi-Fiアクセスポイントに接続されていること**です。

  - ESP32は `192.168.4.1` という固定IPアドレスを持つ親機（ルーター）として動作します。
  - サーバーPCおよびユーザー端末は、ESP32のWi-Fiに接続する子機となり、`192.168.4.x` の形式のIPアドレスが割り当てられます。
  - これにより、全コンポーネントが同一のローカルネットワーク内に存在し、直接通信が可能になります。

-----

## 5\. 設計思想と仕様詳細

### 役割分担 (クライアント-サーバーモデル)

本システムは、ESP32を「クライアント」、サーバーPCを「サーバー」とする明確な役割分担に基づいています。

  - **ESP32**: ユーザーとのインターフェースに特化し、複雑な処理は行いません。
  - **サーバーPC**: 計算負荷の高いAI推論や音声合成など、専門的な処理を一手に引き受けます。

### 状態管理 (ステート管理)

会話の文脈を維持するための会話履歴（状態、ステート）の管理は、意図的に**ESP32側**で行われます。

  - **ESP32 (`esp32_main.py`)**: ユーザーとの一連の対話をセッションとして管理し、その履歴を`ChatSession`クラスで保持します。リクエストのたびに、この完全な会話履歴をサーバーPCに送信します。これは「**ステートフル**」な設計です。
  - **サーバーPC (`voice_chat_server.py`)**: 過去のやり取りを記憶せず、受け取ったリクエストをその場で処理して返すことだけに集中します。これにより、サーバー側の実装がシンプルになります。これは「**ステートレス**」な設計です。

### APIエンドポイント

各コンポーネント間の通信パス（エンドポイント）は以下の通りです。

  - **ユーザー → ESP32**: `http://192.168.4.1/chat` (POST)
  - **ESP32 → サーバーPC**: `http://<サーバーPCのIP>:8000/chat` (POST)
  - **サーバーPC → Ollama**: `http://localhost:11434/api/chat` (POST)

-----

## 6\. セットアップと実行手順

1.  **事前準備**: サーバーPCにOllamaとVOICEVOX Engineをインストールし、起動しておきます。
2.  **ESP32の起動**: `esp32_main.py`をESP32に書き込み、起動します。`ESP32-Ollama-Chat`というWi-Fiアクセスポイントが開始されます。
3.  **サーバーPCの接続**: サーバーPCのWi-Fiを、ESP32が提供する`ESP32-Ollama-Chat`に接続します。
4.  **中間サーバーの起動**: サーバーPCでターミナルを開き、`voice_chat_server.py`を実行します。
    ```bash
    python voice_chat_server.py
    ```
5.  **チャットの開始**: スマートフォンなどのユーザー端末をESP32のWi-Fiに接続し、Webブラウザで `http://192.168.4.1` にアクセスします。
